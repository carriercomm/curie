<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Curie</title>

        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css" type="text/css" media="screen" charset="utf-8">
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-responsive.css" type="text/css">

        <link rel="stylesheet" href="/static/css/base.css" type="text/css" media="screen" charset="utf-8">

        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,600&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>


        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

        <script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

        <script src="/static/js/underscore-min.js" type="text/javascript"></script>
        <script src="/static/js/backbone-min.js" type="text/javascript"></script>

        <script src="/static/js/moment.min.js" type="text/javascript"></script>

        <script src="/static/js/jsSHA/sha512.js" type="text/javascript"></script>
        <script src="/static/js/handlebars.runtime.js" type="text/javascript"></script>

        <script src="/static/js/templates.js" type="text/javascript"></script>

        <script src="/static/js/models.js" type="text/javascript"></script>
        <script src="/static/js/views.js" type="text/javascript"></script>
        <script src="/static/js/routes.js" type="text/javascript"></script>

        <script src="/static/js/login-modal.js" type="text/javascript"></script>

        <script src="/static/js/utils.js" type="text/javascript"></script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/js/backbone-socketio-sync.js"></script>
        

    </head>
    <body>
    <div class="container-fluid app">
        <div class="row-fluid">
            <div class="span3">
                <div class="sidebar-nav sidebar-nav-fixed">
                     <ul class="nav nav-list packs well" id="packList">
                     </ul>
                    <div class="muted text-center sidebarInfo" id="lastFetchTime"></div>
                    <div class="muted text-center alert alert-error hide sidebarInfo" id="errorAlert"></div>
                </div>
            </div>
            <script>
                window.curie = window.curie || {};

                function dummy() {};

                function showAlert(msg) {
                    $("#errorAlert").html(msg).show();
                }

                function hideAlert() {
                    $("#errorAlert").html("").hide();
                }

                function createConnection(options, successCallback, failCallback) {


                    successCallback = successCallback || dummy;
                    failCallback = failCallback || dummy;

                    var email = options.email || null,
                        password = options.password || null,
                        channel = options.channel || new jsSHA(email, "TEXT").getHash("SHA-512", "HEX");

                    var initialData = {
                        secure: true,
                        port: 443,
                        'force new connection': true
                    }
                    if (email && password) {
                        initialData.query = "email=" + email + "&password=" + password;
                    }

                    var socket = window.curie.socket = io.connect('/stream/' + channel, initialData);

                    socket.on('error', function() {
                        showAlert("Socket error");
                        //FIXME: drop all models from memory 
                        failCallback();
                    });
                    socket.on('session-id', function(sessionId) {
                        console.info("Setting session to " + sessionId);
                        setCookie("session", sessionId);
                    });
                    socket.on('connect', function() {
                        hideAlert(); // maybe we were showing some connection-related alerts
                        console.info("Connection to " + channel + " created");

                        setCookie("stream", channel);
                        initDataLoad();
                        successCallback();
                    });
                    socket.on("disconnect", function() {
                        showAlert("Disconneted");
                    });
                }

                function initInterface() {
                    window.curie.appView = new AppView(["inbox", "sent", "facebook"]);
                    window.curie.router = new AppRouter(window.curie.appView);

                    window.curie.appView.render();
                }

                function initDataLoad() {
                    window.curie.socket.on('new-messages', function(data) {
                        window.curie.appView.addMessage(data.message);
                    });
                    window.curie.appView.fetchPacks();

                    Backbone.history.stop();
                    Backbone.history.start();
                    setInterval(function() {
                        window.curie.appView.fetchPacks();
                    }, 10 * 1000); 
                }

            </script>
            <div class="span9" id="packView">
            </div>
        </div>
    </div>


        <div class="modal hide" id="loginModal" data-backdrop="static" data-keyboard="false" data-show="true"></div>

        <script>

            $(function() {
                initInterface();

                window.curie.loginModal = LoginModal().create();

                if (window.readCookie("curie.stream")) {
                    console.info("Stream exists! " + window.readCookie("curie.stream"));
                    createConnection({
                        channel : window.readCookie("curie.stream")
                    }, function() {
                        console.info("Connection created");
                    }, function() {
                        console.info("Stream is dead, showing loginModal");
                        window.curie.loginModal.show();
                    });
                } else {
                    window.curie.loginModal.show();
                }

            });
        </script>

    </body>
</html>

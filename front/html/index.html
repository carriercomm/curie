<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Curie</title>

        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap.css" type="text/css" media="screen" charset="utf-8"/>
        <link rel="stylesheet" href="/static/bootstrap/css/bootstrap-responsive.css" type="text/css"/>

        <link rel="stylesheet" href="/static/css/base.css" type="text/css" media="screen" charset="utf-8"/>

        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,600&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'/>


        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

        <script src="/static/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>

        <script src="/static/js/libs/underscore-min.js" type="text/javascript"></script>
        <script src="/static/js/libs/backbone-min.js" type="text/javascript"></script>

        <script src="/static/js/libs/moment.min.js" type="text/javascript"></script>
        <script src="/static/js/libs/mousetrap.min.js" type="text/javascript"></script>

        <script src="/static/js/libs/jsSHA/sha512.js" type="text/javascript"></script>
        <script src="/static/js/libs/handlebars.runtime.js" type="text/javascript"></script>

        <script src="/static/js/templates.js" type="text/javascript"></script>
        <script src="/static/js/models.js" type="text/javascript"></script>

        <script src="/static/js/draftController.js" type="text/javascript"></script>
        <script src="/static/js/searchController.js" type="text/javascript"></script>
        <script src="/static/js/controller.js" type="text/javascript"></script>

        <script src="/static/js/views/packList.js" type="text/javascript"></script>
        <script src="/static/js/views/pack.js" type="text/javascript"></script>
        <script src="/static/js/views/message.js" type="text/javascript"></script>
        <script src="/static/js/views/thread.js" type="text/javascript"></script>
        <script src="/static/js/views/search.js" type="text/javascript"></script>
        <script src="/static/js/views/draft.js" type="text/javascript"></script>

        <script src="/static/js/routes.js" type="text/javascript"></script>
        <script src="/static/js/hotkeys.js" type="text/javascript"></script>

        <script src="/static/js/login-modal.js" type="text/javascript"></script>

        <script src="/static/js/utils.js" type="text/javascript"></script>
        <script src="/static/js/entities.js"></script>

        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/js/sync.js"></script>
        

    </head>
    <body>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19186351-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>


    <div class="container-fluid app">
        <div class="row-fluid mainBlock hide">
            <div class="span3">
                <div class="sidebar-nav sidebar-nav-fixed sidebarNav">
                    <div id="packBlocks">
                    </div>
                    <div class="packs" style="padding:10px 0px;">
                        <label class="nav-header">predefined</label>
                        <ul class="nav nav-list">
                            <li><a href="#search/K3JlY2VpdmVkOltOT1cvREFZIFRPIE5PVy9EQVkrMURBWV0%3D">today</a></li>
                            <li><a href="#search/K3JlY2VpdmVkOltOT1cvREFZLTFEQVkgVE8gTk9XL0RBWV0%3D">yesterday</a></li>
                            <li><a href="#search/K3VucmVhZDp0cnVl">all unread</a></li>
                        </ul>
                    </div>
                    <ul class="nav nav-list packs">
                        <li id="newMessageLi"><a href="#" onClick="javascript:window.curie.controller.routeToNew();return false">new message</a></li>
                    </ul>
                    <div class="text-center">
                        <br/>
                        <div class="btn-group">
                            <button class="btn" name="showAs" data-value="LIST"><i class="icon-align-justify"></i></button>
                            <button class="btn" name="showAs" data-value="COMBINED"><i class="icon-th-list"></i></button>
                            <button class="btn" name="showAs" data-value="TILES"><i class="icon-th-large"></i></button>
                        </div>
                    </div>
                    <div class="muted text-center alert alert-error hide sidebarInfo" id="errorAlert"></div>
                    <br/>
                    <div class="muted text-center sidebarInfo" id="accountInfo"></div>
                    <div class="muted text-center sidebarInfo" id="lastFetchTime"></div>
                    <div class="text-center muted">Hotkeys help: "?"</div>
                </div>
            </div>
            <script>

                window.curie = window.curie || {};

                var PERIODIC_FETCH = 0;//10 * 1000;//20 * 1000;
                var RECONNECT_DELAY = 100;
                var RECONNECT_GIVE_UP_RETRIES = 10;

                function dummy() {};

                function showAlert(msg, reason) {
                    $("#errorAlert").html(msg).show();
                    console.error(reason);
                }

                function hideAlert() {
                    $("#errorAlert").html("").hide();
                }

                stateModel.on("connection:established", hideAlert);
                stateModel.on("connection:error", showAlert);

                function createDataConnection() {


                    var channel = window.readCookie("curie.channel");
                    if (!channel) {
                        console.error("No channel specified");
                        return;
                    }

                    console.info("Creating data connection to channel=" + channel);

                    var initialData = {
                        secure: true,
                        port: 443,
                        'force new connection': true,
                        'reconnect': true,
                        'reconnection delay': RECONNECT_DELAY,
                        'max reconnection attempts': RECONNECT_GIVE_UP_RETRIES
                    }

                    var socket = window.curie.socket = io.connect('/stream/' + channel, initialData);

                    socket.on('error', function(reason) {
                        stateModel.trigger("connection:error", "Connection error", reason);
                        stateModel.trigger("logout");
                    });
                    socket.on('connect', function() {
                        console.info("Connection to " + channel + " created");
                        stateModel.trigger("login-success");
                        stateModel.trigger("connection:established");

                        //FIXME: move to controller
                        initDataLoad();
                    });
                    socket.on('reconnect', function() {
                        stateModel.trigger("connection:established");

                        console.info("Reconnected to " + channel);
                    });
                    socket.on('reconnecting', function(delay, attempt) {
                        console.info("Reconnecting for " + attempt + " time, with delay " + delay);
                        if (attempt == RECONNECT_GIVE_UP_RETRIES) {
                            stateModel.trigger("logout");
                        }
                    });
                    socket.on("disconnect", function(reason) {
                        stateModel.trigger("connection:error", "Disconnect", reason);
                    });
                }

                function initInterface() {
                    window.curie.controller = new Controller();
                    window.curie.router = new AppRouter(window.curie.controller);
                }

                function initDataLoad() {
                    window.curie.controller.firstFetch(function() {
                        // we will start routing when the data schema is ready

                        Backbone.history.stop();
                        Backbone.history.start();
                        if (PERIODIC_FETCH) {
                            setInterval(function() {
                                window.curie.controller.refetch();
                            }, PERIODIC_FETCH); 
                        }
                    });
                }

            </script>
            <div class="span9" id="packView">
                <div id="view" class="popupView">
                    <button type="button" class="close" aria-hidden="true">&times;</button>
                    <div class="content"></div>
                </div>
                <div id="list"></div>
            </div>
        </div>

        <div class="modal hide" id="loginModal" data-backdrop="static" data-keyboard="false" data-show="false"></div>
        <div class="modal hide" id="hotkeysModal" data-backdrop="true" data-keyboard="true" data-show="true" tabindex="-1"></div>

        <div class="searchPopup hide" id="searchPopup"><form id="searchForm"><input type="text" name="search"/></form></div>
    </div>



        <script>

            function reconnect() {
                var channel = window.readCookie("curie.channel");
                if (channel) {
                    console.info("Stream exists! " + channel);
                    createDataConnection();
                } else {
                    stateModel.trigger("login-show-popup");
                }
            }

            $(function() {
                initInterface();
                reconnect();
            });
        </script>

    </body>
</html>
